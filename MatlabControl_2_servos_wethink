//This script is meant to be used in arduino, in tandem with Open_serial

#include <DynamixelWorkbench.h>

DynamixelWorkbench dxl_wb;

int high = -1;
int low = -1;
uint32_t get_data_1;
uint32_t get_data_2;

void setup() {
  // put your setup code here, to run once:
  //Initialize communication with dynamixel motors
  dxl_wb.init("1",1000000);

  //Ping motor 1 so that we can send commands and read data
  uint16_t model_number=0;
  dxl_wb.ping(1, &model_number);

  //Initialize serial communication with a boudrate of 9600
  Serial.begin(9600);

}

void loop() {
  // put your main code here, to run repeatedly:

  //Check to see how many bytes of data are being stored in buffer
  if(Serial.available() > 1)
  {
  
  //Read position and send to Servo 1
    //Read in low and high bytes of a 10 bit number
    low = Serial.read();
    high = Serial.read();

    //Control motor 1 to go to the number we read in
    dxl_wb.goalPosition(1, (int32_t) (low + high*365));
    delay(3000); //wait until we get to the position before we continue

    //Checks the Position property of the dynamixel
    dxl_wb.readRegister(1, (uint16_t)36, (uint16_t)1, &get_data_1);
    dxl_wb.readRegister(1, (uint16_t)37, (uint16_t)1, &get_data_2);

    //Sends the low and high bytes over the serial port back to Matlab
    Serial.write((int8_t) get_data_1);
    Serial.write((int8_t) get_data_2);
    
  //Read 2nd position information and send to Servo 2
      //Read in low and high bytes of a 10 bit number
    low = Serial.read();
    high = Serial.read();

    //Control motor 2 to go to the number we read in
    dxl_wb.goalPosition(2, (int32_t) (low + high*365));
    delay(3000); //wait until we get to the position before we continue

    //Checks the Position property of the dynamixel
    dxl_wb.readRegister(2, (uint16_t)36, (uint16_t)1, &get_data_1);
    dxl_wb.readRegister(2, (uint16_t)37, (uint16_t)1, &get_data_2);

    //Sends the low and high bytes over the serial port back to Matlab
    Serial.write((int8_t) get_data_1);
    Serial.write((int8_t) get_data_2);
  }
  
  }
